<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Camera Test</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
  #reader, video { width: 100%; max-width: 400px; margin: 1rem auto; display: block; }
</style>
</head>
<body class="container py-4">
<h2 class="text-center mb-4">QR Camera Test</h2>

<div class="mb-3">
  <label class="form-label">Camera Facing:</label>
  <select id="cameraFacing" class="form-select">
    <option value="environment">Rear (Environment)</option>
    <option value="user">Front</option>
  </select>
</div>

<button id="startHtml5Qr" class="btn btn-primary w-100 mb-3">Start Html5Qrcode Scan</button>
<button id="stopHtml5Qr" class="btn btn-danger w-100 mb-3">Stop Scan</button>
<div id="reader" class="border shadow-sm p-2"></div>

<h5 class="mt-4">Direct getUserMedia Test</h5>
<button id="startDirectCamera" class="btn btn-secondary w-100 mb-3">Start Camera</button>
<video id="directVideo" autoplay muted playsinline class="border shadow-sm"></video>

<div class="mt-4">
  <h5>Console Output:</h5>
  <pre id="logOutput" class="p-2 border bg-light" style="height:150px; overflow:auto;"></pre>
</div>

<script>
const log = msg => {
  console.log(msg);
  const out = document.getElementById("logOutput");
  out.textContent += msg + "\n";
  out.scrollTop = out.scrollHeight;
};

let html5QrCode;

// --- Html5Qrcode Scan ---
document.getElementById("startHtml5Qr").addEventListener("click", async () => {
  if (typeof Html5Qrcode === "undefined") {
    log("❌ Html5Qrcode is undefined. Library not loaded.");
    return;
  }

  const facing = document.getElementById("cameraFacing").value;
  html5QrCode = new Html5Qrcode("reader");

  try {
    await html5QrCode.start(
      { facingMode: facing },
      { fps: 10, qrbox: 250 },
      decodedText => {
        log("✅ QR Code Scanned: " + decodedText);
        // Stop scanner after one scan
        html5QrCode.stop().then(() => html5QrCode.clear());
      },
      err => {
        // ignore scanning errors
      }
    );
    log("Camera started with facingMode: " + facing);
  } catch (err) {
    log("❌ Html5Qrcode start error: " + err);
  }
});

document.getElementById("stopHtml5Qr").addEventListener("click", async () => {
  if (html5QrCode) {
    await html5QrCode.stop();
    html5QrCode.clear();
    log("Stopped Html5Qrcode scanner.");
  }
});

// --- Direct getUserMedia Test ---
document.getElementById("startDirectCamera").addEventListener("click", async () => {
  const facing = document.getElementById("cameraFacing").value;
  try {
    const constraints = { video: { facingMode: facing } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById("directVideo");
    video.srcObject = stream;
    log("✅ getUserMedia camera started with facingMode: " + facing);
  } catch (err) {
    log("❌ getUserMedia error: " + err);
  }
});

// --- List Cameras ---
navigator.mediaDevices.enumerateDevices().then(devices => {
  devices.forEach(d => log(`${d.kind}: ${d.label}`));
}).catch(err => log("❌ enumerateDevices error: " + err));
</script>
</body>
</html>
