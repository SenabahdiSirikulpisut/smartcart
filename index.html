<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Cart</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: sans-serif; padding: 10px; }
.hidden { display: none; }
.product-card { border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 5px; }
#summary { position: fixed; right: 0; top: 0; width: 200px; background: #f9f9f9; padding: 10px; }
</style>
</head>
<body>

<h2>Welcome to Smart Cart</h2>

<div id="segment-selection">
  <p>Select your segment:</p>
  <button onclick="startSession('Nutrition')">Goal-Achiever (Nutrition)</button>
  <button onclick="startSession('Budget')">Budget Lover</button>
  <button onclick="startSession('Household')">Household / Houseware</button>
</div>

<div id="qr-scanner" class="hidden">
  <h3>Scan QR code on shelf</h3>
  <div id="reader" style="width:100%;"></div>
</div>

<div id="products" class="hidden"></div>

<div id="summary" class="hidden">
  <h4>Summary</h4>
  <pre id="summary-content"></pre>
  <button onclick="fetchSummary()">Refresh Summary</button>
</div>

<script>
const BACKEND = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhoPoM5T9VlKjEtjGaYJxqzrkBiJjjER_CoN7vD-z5T3zqIUY9Nk_nDhhvUfUtnVd8mmSnBbpDp7Wm9YZ2j7dLv_2917cTK9vwTYXobd_e15VxKBaTCGlhasVPXEmdv1jFq3px--RSKVn5SykSO9bqgHO58yhWz6zGqiISkt2r_XKcZjY89ezsOMQK4Gul0rdAJdG0ESuRNhDkjMhCVGl1Ekv-wAwLG-8TRDU3XOTCuBEh8XNtyDSCOgPw67pZB_FR0zq1on7oz2Gn73CMoFQIW8ZvWcdP8kytmi7EL&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt";
let customerId = "cust_" + Math.floor(Math.random()*100000);
let currentSegment = "";
let lastQRToken = "";

function startSession(segment) {
  currentSegment = segment;
  fetch(BACKEND, {
    method: "POST",
    body: JSON.stringify({ action:"startSession", customerId, segment })
  }).then(r=>r.json()).then(()=> {
    document.getElementById('segment-selection').classList.add('hidden');
    document.getElementById('qr-scanner').classList.remove('hidden');
    initQRScanner();
  });
}

function initQRScanner() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      lastQRToken = qrCodeMessage;
      document.getElementById('qr-scanner').classList.add('hidden');
      fetch(BACKEND, {
        method: "POST",
        body: JSON.stringify({ action:"scanQR", customerId, qrToken:lastQRToken })
      }).then(()=> fetchProducts());
      html5QrCode.stop();
    },
    errorMessage => { /* ignore scan errors */ }
  );
}

function fetchProducts() {
  fetch(BACKEND, {
    method: "POST",
    body: JSON.stringify({ action:"getProducts", customerId, segment:currentSegment, qrToken:lastQRToken })
  }).then(r=>r.json()).then(data => {
    const container = document.getElementById('products');
    container.innerHTML = "";
    data.products.forEach(p=>{
      const div = document.createElement('div');
      div.className = "product-card";
      div.innerHTML = `<b>${p.name}</b><br>Category: ${p.category}<br>Price: ${p.price}<br>Calories: ${p.calories}, Protein: ${p.protein}, Sugar: ${p.sugar}<br><button onclick="recordClick('${p.productId}')">Click</button>`;
      container.appendChild(div);
    });
    container.classList.remove('hidden');
    document.getElementById('summary').classList.remove('hidden');
  });
}

function recordClick(productId) {
  fetch(BACKEND, {
    method: "POST",
    body: JSON.stringify({ action:"recordClick", customerId, productId, segment:currentSegment, qrToken:lastQRToken, action:"click" })
  }).then(()=> fetchProducts()); // refresh products with recommendations
}

function fetchSummary() {
  fetch(BACKEND, {
    method: "POST",
    body: JSON.stringify({ action:"getSummary", customerId })
  }).then(r=>r.json()).then(data=>{
    document.getElementById('summary-content').textContent = JSON.stringify(data.summary, null, 2);
  });
}
</script>
</body>
</html>
