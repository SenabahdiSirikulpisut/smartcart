<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SmartCart</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { background-color: #f8f9fa; padding: 1rem; }
  #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 1rem; overflow: hidden; display:none; }
  .product-card { transition: transform 0.2s ease-in-out; margin-bottom: 1rem; }
  .product-card:hover { transform: scale(1.03); }
</style>
</head>
<body class="container py-4">

<h2 class="text-center mb-4">ðŸ›’ SmartCart</h2>

<!-- Login Section -->
<div id="loginSection" class="card p-3 shadow-sm">
  <div class="mb-3">
    <label class="form-label">Customer ID</label>
    <input type="text" id="customerId" class="form-control" placeholder="Enter your ID" />
  </div>
  <div class="mb-3">
    <label class="form-label">Shopping Focus</label>
    <select id="focus" class="form-select">
      <option value="Nutrition">Nutrition</option>
      <option value="Budget">Budget</option>
      <option value="Household">Household</option>
    </select>
  </div>
  <button id="startSession" class="btn btn-primary w-100">Start Session</button>
</div>

<!-- Main Screen after Session Start -->
<div id="mainScreen" class="d-none mt-4">
  <div class="d-flex justify-content-between mb-3">
    <button id="scanQRBtn" class="btn btn-success">Scan QR in Zones</button>
    <button id="cameraTestBtn" class="btn btn-warning">Direct Camera Test</button>
    <button id="viewSummaryBtn" class="btn btn-info">View Summary</button>
  </div>

  <div id="reader" class="shadow"></div>

  <div id="recommendationsSection" class="mt-4 d-none">
    <h5>Recommended Products</h5>
    <div id="recommendations" class="row g-3"></div>
  </div>

  <div id="summarySection" class="mt-4 d-none">
    <h5>Session Summary</h5>
    <div id="summaryContent" class="card p-3 shadow-sm"></div>
  </div>
</div>

<!-- Session Confirmation Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <h5>âœ… Session Started</h5>
        <p>Welcome! Press "Scan QR in Zones" to begin exploring product recommendations.</p>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
      </div>
    </div>
  </div>
</div>

<script defer>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxfGHWQWxeMyQyi40iYq9vWRO1tSfl0ADSN-mOflDamZ5YrGR5HCGI6Dy0Ga45Nf-0Dsw/exec";

let html5QrCode;
let customerId = "";
let focus = "";

// Elements
const loginSection = document.getElementById("loginSection");
const mainScreen = document.getElementById("mainScreen");
const scanQRBtn = document.getElementById("scanQRBtn");
const cameraTestBtn = document.getElementById("cameraTestBtn");
const viewSummaryBtn = document.getElementById("viewSummaryBtn");
const readerDiv = document.getElementById("reader");
const recommendationsSection = document.getElementById("recommendationsSection");
const recommendationsContainer = document.getElementById("recommendations");
const summarySection = document.getElementById("summarySection");
const summaryContent = document.getElementById("summaryContent");

window.addEventListener("DOMContentLoaded", () => {

  document.getElementById("startSession").addEventListener("click", async () => {
    customerId = document.getElementById("customerId").value.trim();
    focus = document.getElementById("focus").value;
    if (!customerId) return alert("Please enter Customer ID.");

    try {
      await jsonp(`${BACKEND_URL}?action=startSession&customerId=${customerId}&focus=${focus}`);
      loginSection.classList.add("d-none");
      mainScreen.classList.remove("d-none");
      const sessionModal = new bootstrap.Modal(document.getElementById("sessionModal"));
      sessionModal.show();
    } catch (err) {
      console.error(err);
      alert("Failed to start session. Please check your connection.");
    }
  });

  scanQRBtn.addEventListener("click", () => startScanner(true));
  cameraTestBtn.addEventListener("click", () => startScanner(false));
  viewSummaryBtn.addEventListener("click", () => loadSummary());
});

// === QR / Camera Scanner ===
async function startScanner(isQRScan) {
  // Dynamically load QR library if not loaded
  if (!window.Html5Qrcode) {
    await new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = "https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js";
      script.onload = resolve;
      script.onerror = reject;
      document.body.appendChild(script);
    });
  }

  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  readerDiv.style.display = "block";

  // Disable the correct button
  if (isQRScan) scanQRBtn.disabled = true;
  else cameraTestBtn.disabled = true;

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (decodedText) => {
      await html5QrCode.stop();
      html5QrCode.clear();
      readerDiv.style.display = "none";

      if (isQRScan) scanQRBtn.disabled = false;
      else cameraTestBtn.disabled = false;

      if (isQRScan) {
        const recs = await fetchRecommendations(decodedText);
        displayProducts(recs);
      } else {
        alert("Camera test successful!");
      }
    },
    (err) => {}
  );
}

// === Fetch Recommendations from backend ===
async function fetchRecommendations(token) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Date.now();
    window[callbackName] = (data) => { delete window[callbackName]; resolve(data.recommendations || []); };
    const script = document.createElement("script");
    script.src = `${BACKEND_URL}?action=getRecommendations&productId=${encodeURIComponent(token)}&customerId=${customerId}&focus=${focus}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// === Record click & fetch next recommendations ===
async function recordClickAndFetchNext(productId) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Date.now();
    window[callbackName] = (data) => { delete window[callbackName]; resolve(data.recommendations || []); };
    const script = document.createElement("script");
    script.src = `${BACKEND_URL}?action=recordClick&customerId=${customerId}&productId=${productId}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// === Display products ===
function displayProducts(products) {
  recommendationsSection.classList.remove("d-none");
  recommendationsContainer.innerHTML = "";
  if (!products.length) { recommendationsContainer.innerHTML = `<p class="text-muted">No recommendations found.</p>`; return; }

  products.forEach(p => {
    const card = document.createElement("div");
    card.className = "col-md-4 product-card";
    card.innerHTML = `
      <div class="card h-100 shadow-sm text-center p-2">
        <h6>${p.name}</h6>
        <p class="small text-muted">${p.category}</p>
        <button class="btn btn-outline-primary btn-sm">View / Add</button>
      </div>
    `;
    card.querySelector("button").addEventListener("click", async () => {
      const recs = await recordClickAndFetchNext(p.productId);
      displayProducts(recs);
    });
    recommendationsContainer.appendChild(card);
  });
}

// === Load Summary ===
function loadSummary() {
  jsonp(`${BACKEND_URL}?action=getSummary&customerId=${customerId}`).then(data => {
    summarySection.classList.remove("d-none");
    const s = data.summary[customerId] || {};
    summaryContent.innerHTML = `
      <p><strong>Nutrition:</strong> Calories ${s.Nutrition?.calories || 0}, Protein ${s.Nutrition?.protein || 0}, Sugar ${s.Nutrition?.sugar || 0}</p>
      <p><strong>Budget:</strong> ${s.Budget?.total || 0}</p>
      <p><strong>Household:</strong> ${s.Household?.checklist?.join(", ") || "None"}</p>
    `;
  });
}

// === JSONP helper ===
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const callbackName = "jsonp_callback_" + Math.round(100000 * Math.random());
    window[callbackName] = (data) => { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
    const script = document.createElement("script");
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

