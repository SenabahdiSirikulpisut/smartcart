<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartCart 7-Eleven</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='26' font-size='26'%3E%F0%9F%8D%90%3C/text%3E%3C/svg%3E">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f8f9fa; padding: 1rem; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
#reader, #debugVideo { width: 100%; max-width: 420px; margin: 0 auto 1rem auto; border-radius: 12px; overflow:hidden; display:none; background:#000; }
.product-card { transition: transform .14s ease-in-out; }
.product-card:hover { transform: translateY(-4px); }
#troubleshootLog { height:160px; overflow:auto; background:#fff; border:1px solid #eee; padding:.5rem; font-size:.875rem; }
.muted-small { font-size:.85rem; color:#6c757d; }
.filter-section { margin-bottom: 1rem; }
</style>
</head>
<body class="container py-4">

<h2 class="text-center mb-3">üõí SmartCart</h2>

<!-- Login Section -->
<div id="loginSection" class="card p-3 mb-3 shadow-sm">
  <button id="startSession" class="btn btn-primary w-100">Start Session</button>
  <div class="mt-2 muted-small">Session will initialize the SmartCart experience.</div>
</div>

<!-- Main Screen -->
<div id="mainScreen" class="d-none">

  <!-- QR + Filter + Cart -->
  <div class="d-flex gap-2 mb-3">
    <button id="scanQRBtn" class="btn btn-success flex-grow-1">Scan QR in Zones</button>
    <button id="toggleFiltersBtn" class="btn btn-warning">Filters</button>
    <button id="viewCartBtn" class="btn btn-info">View Cart</button>
  </div>

  <div id="reader" class="shadow"></div>

  <!-- Filter Section -->
  <div id="filterSection" class="filter-section d-none card p-3 mb-3">
    <h6>Nutrition Filter</h6>
    <div class="row g-2">
      <div class="col"><input type="number" id="maxCalories" class="form-control" placeholder="Max Calories"></div>
      <div class="col"><input type="number" id="minProtein" class="form-control" placeholder="Min Protein"></div>
      <div class="col"><input type="number" id="maxSugar" class="form-control" placeholder="Max Sugar"></div>
      <div class="col-auto"><button id="applyFilterBtn" class="btn btn-primary">Apply</button></div>
    </div>
  </div>

  <!-- Recommendations -->
  <div id="recommendationsSection" class="mt-3 d-none">
    <h5>Recommended Products</h5>
    <div id="recommendations" class="row g-3"></div>
    <button id="closeProductRecs" class="btn btn-secondary mt-2 d-none">Close Product Recommendations</button>
    <button id="closeZoneRecs" class="btn btn-warning mt-2 d-none">Close Zone Recommendations</button>
  </div>

  <!-- Cart -->
  <div id="cartSection" class="mt-3 d-none">
    <h5>Your Cart</h5>
    <div id="cartContent" class="card p-3 mb-3"></div>
    <div class="text-end"><strong>Total: ‡∏ø<span id="cartTotal">0</span></strong></div>
  </div>

  <!-- Troubleshooting panel -->
  <div class="card mt-4 p-3">
    <h6>Camera Troubleshooting</h6>
    <div class="d-flex gap-2 mb-2">
      <button id="btnGetUserMedia" class="btn btn-outline-secondary btn-sm">Test Camera</button>
      <button id="btnTryAll" class="btn btn-outline-primary btn-sm">Try All Camera Options</button>
    </div>
    <div id="debugVideo" class="mb-2"></div>
    <div id="troubleshootLog" class="mb-2"></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwAYBCR4NLyml6D2mkOdgwcwcvBuYs-e-OSWQ-iAWkMNx1-Mq390_vZVys8MEvlDK4QpQ/exec";

/* ======= UI Refs ======= */
const loginSection = document.getElementById('loginSection');
const mainScreen = document.getElementById('mainScreen');
const startSessionBtn = document.getElementById('startSession');
const scanQRBtn = document.getElementById('scanQRBtn');
const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
const applyFilterBtn = document.getElementById('applyFilterBtn');
const closeProductRecsBtn = document.getElementById('closeProductRecs');
const closeZoneRecsBtn = document.getElementById('closeZoneRecs');
const viewCartBtn = document.getElementById('viewCartBtn');
const readerDiv = document.getElementById('reader');
const recommendationsSection = document.getElementById('recommendationsSection');
const recommendationsContainer = document.getElementById('recommendations');
const filterSection = document.getElementById('filterSection');
const cartSection = document.getElementById('cartSection');
const cartContent = document.getElementById('cartContent');
const cartTotal = document.getElementById('cartTotal');
const logBox = document.getElementById('troubleshootLog');

let html5QrCode = null;
let sessionId = '';
let activeZoneId = '';
let filters = { maxCalories:null, minProtein:null, maxSugar:null };
let cart = [];

/* ======= JSONP Helper ======= */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.round(Math.random()*1e9);
    window[cb]=(data)=>{delete window[cb];resolve(data);};
    const s=document.createElement('script');
    s.src=`${url}${url.includes('?')?'&':'?'}callback=${cb}`;
    s.onerror=()=>reject(new Error('JSONP failed'));
    document.body.appendChild(s);
  });
}

/* ======= Session ======= */
startSessionBtn.onclick = async()=>{
  const res = await jsonp(`${BACKEND_URL}?action=startSession`);
  sessionId = res.sessionId;
  loginSection.classList.add('d-none');
  mainScreen.classList.remove('d-none');
};

/* ======= QR Scanner ======= */
scanQRBtn.onclick = async()=>{
  if(typeof Html5Qrcode==='undefined'){
    await loadScript('https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js');
  }
  if(!html5QrCode) html5QrCode = new Html5Qrcode('reader');
  readerDiv.style.display='block';
  scanQRBtn.disabled=true;
  html5QrCode.start({facingMode:'environment'}, {fps:10, qrbox:250},
    async decoded=>{
      try{await html5QrCode.stop(); html5QrCode.clear();}catch{}
      readerDiv.style.display='none';
      scanQRBtn.disabled=false;
      activeZoneId=decoded;
      fetchAndDisplayZone(decoded);
    });
};
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.onload=res;s.onerror=rej;s.src=src;document.body.appendChild(s);});}

/* ======= Zone Recommendations ======= */
async function fetchAndDisplayZone(zoneId){
  const data = await jsonp(`${BACKEND_URL}?action=getZoneRecommendations&zoneId=${encodeURIComponent(zoneId)}`);
  const recs = (data.recommendations||[])
    .map(r=>r.product)
    .filter(p=>{
      if(filters.maxCalories && p.calories>filters.maxCalories) return false;
      if(filters.minProtein && p.protein<filters.minProtein) return false;
      if(filters.maxSugar && p.sugar>filters.maxSugar) return false;
      return true;
    });
  renderProductCards(recs, "Zone Recommendations");
}

/* ======= Product-Level Recommendations (Bundle + FBT) ======= */
async function handleProductClick(productId){
  try {
    const data = await jsonp(`${BACKEND_URL}?action=getProductRecommendations&productId=${encodeURIComponent(productId)}`);
    console.log('Product recommendations:', data);

    const bundles = data.bundle || [];
    const fbt = data.frequently_bought_with || [];

    recommendationsSection.classList.remove('d-none');
    closeZoneRecsBtn.classList.add('d-none');
    closeProductRecsBtn.classList.remove('d-none');

    displayProductRecommendations({ bundles, fbt });
  } catch (err) {
    logBox.textContent += '\nError fetching product recs: ' + err.message;
  }
}

function displayProductRecommendations({ bundles = [], fbt = [] }) {
  recommendationsContainer.innerHTML = '';

  if (!bundles.length && !fbt.length) {
    recommendationsContainer.innerHTML = '<div class="text-muted">No further recommendations.</div>';
    return;
  }

  const makeCard = (p) => `
    <div class="col-md-4 product-card">
      <div class="card h-100 shadow-sm p-2 text-center">
        <img src="${p.image || 'https://via.placeholder.com/100'}" class="img-fluid mb-2"/>
        <h6>${p.name}</h6>
        <p class="small text-muted mb-2">${p.category || ''}</p>
        <p class="mb-1">‡∏ø${p.price}</p>
        <button class="btn btn-outline-primary btn-sm add-btn" data-id="${p.product_id}">Add</button>
      </div>
    </div>`;

  if (bundles.length) {
    recommendationsContainer.innerHTML += `<h6 class="mt-2">üç± Bundle Set</h6><div class="row g-3 mb-3">${bundles.map(makeCard).join('')}</div>`;
  }

  if (fbt.length) {
    recommendationsContainer.innerHTML += `<h6 class="mt-3">ü§ù Frequently Bought Together</h6><div class="row g-3 mb-3">${fbt.map(makeCard).join('')}</div>`;
  }

  // Add button listeners
  recommendationsContainer.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pid = btn.dataset.id;
      const all = [...bundles, ...fbt];
      const product = all.find(p => p.product_id === pid);
      if (product) addToCart(product);
    });
  });
}

/* ======= Rendering Helpers ======= */
function renderProductCards(products, title=""){
  recommendationsSection.classList.remove('d-none');
  recommendationsContainer.innerHTML = title ? `<h5>${title}</h5><div class="row g-3" id="recommendationsGrid"></div>` : '<div class="row g-3" id="recommendationsGrid"></div>';
  const grid = document.getElementById("recommendationsGrid");
  if(!products.length){grid.innerHTML='<div class="text-muted">No products.</div>';return;}
  products.forEach(p=>{
    const card=document.createElement('div');
    card.className='col-md-4 product-card';
    card.innerHTML=`
      <div class="card h-100 shadow-sm p-2 text-center">
        <img src="${p.image||'https://via.placeholder.com/100'}" class="img-fluid mb-2"/>
        <h6>${p.name}</h6>
        <p class="small text-muted">${p.category||''}</p>
        <p>‡∏ø${p.price}</p>
        <button class="btn btn-outline-primary btn-sm">Add / View</button>
      </div>`;
    card.querySelector('button').onclick=()=>addToCart(p) || handleProductClick(p.product_id);
    grid.appendChild(card);
  });
}

/* ======= Close Buttons ======= */
closeProductRecsBtn.onclick=()=>fetchAndDisplayZone(activeZoneId);
closeZoneRecsBtn.onclick=()=>{
  recommendationsSection.classList.add('d-none');
  closeProductRecsBtn.classList.add('d-none');
  closeZoneRecsBtn.classList.add('d-none');
  activeZoneId='';
};

/* ======= Cart ======= */
function addToCart(p){ cart.push(p); updateCart(); }
viewCartBtn.onclick=()=>cartSection.classList.toggle('d-none');
function updateCart(){
  cartContent.innerHTML='';
  let total=0;
  cart.forEach(p=>{
    const row=document.createElement('div');
    row.className='d-flex justify-content-between mb-1';
    row.innerHTML=`<span>${p.name}</span><span>‡∏ø${p.price}</span>`;
    cartContent.appendChild(row);
    total+=p.price||0;
  });
  cartTotal.textContent=total.toFixed(2);
}
</script>

</body>
</html>
