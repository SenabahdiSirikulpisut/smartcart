<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SmartCart Mobile</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #fafafa; font-family: 'Poppins', sans-serif; padding-bottom: 80px; }
  .header { background: #0078d7; color: #fff; padding: 1rem; text-align: center; }
  .product-card { border-radius: 15px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
  .btn-scan { background: #0078d7; color: #fff; width: 100%; font-weight: 600; }
  .btn-scan:hover { background: #005fa3; }
  .floating-btn { position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; }
  .small-muted { font-size: .85rem; color: #666; }
</style>
</head>
<body>

<div class="header">
  <h4>SmartCart Zone Scanner</h4>
</div>

<div class="container mt-4">
  <!-- Setup Section -->
  <div id="setupSection" class="mb-4">
    <div class="mb-2">
      <label for="customerId" class="form-label">Enter your Customer ID</label>
      <input type="text" id="customerId" class="form-control" placeholder="e.g. C12345">
    </div>
    <div class="mb-3">
      <label for="segment" class="form-label">Choose Shopping Focus</label>
      <select id="segment" class="form-select">
        <option value="Nutrition">Nutrition Goals</option>
        <option value="Budget">Budget Saver</option>
        <option value="Household">Household Needs</option>
      </select>
    </div>
    <button id="startSessionBtn" class="btn btn-success w-100">Start My Session</button>
  </div>

  <!-- Scanner Section -->
  <div id="scannerSection" style="display:none;">
    <button id="scanQRBtn" class="btn btn-scan mb-3">ðŸ“· Scan Shelf QR</button>
    <div id="reader" style="width:100%;"></div>
    <div id="liveStatus" class="small-muted mt-2">Ready to scan</div>
  </div>

  <!-- Product List -->
  <div id="productList" class="mt-3"></div>
</div>

<!-- Popup Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="mb-3">âœ… Session Started!</h5>
      <p>Letâ€™s start shopping â€” scan QR codes around the store to see personalized recommendations!</p>
      <button class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
/* ------------- CONFIG ------------- */
const BACKEND_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgNIFJeLRDtJBZ4M2nhs5Zr6raQ57tqDeCUnHmUybOa7PKTrtjNIjvjV09Av1qeRHxXaj3xvPdd752gmdRoMRNipb9wlmdbgoFXBhPFN0gPNjEjBm8b5-J15tIiPBNwIYzDvon1jMOjTh6SzI4TopqcmWf8pgU5s6-VfR7cswmUxcD7yru9Rx0LZFLxUrylzz3WIjGPXcnm5fKvqHc-Y5pJUp3WP6ysjL1PJgJq1IiiKxApYd_EjHLzR38WTBg1KKnIWzMAF4BrBlHUVqROkJJaZT3ll6uorIGWNr-A&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt";
let customerId = "", segment = "", sessionId = "";

/* ------------- JSONP helper ------------- */
/*
  jsonpRequest(url, params, timeoutMs) -> Promise resolving to parsed object
  - builds unique callback name
  - supports timeout & cleanup
*/
function jsonpRequest(url, params = {}, timeoutMs = 8000) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
    params.callback = callbackName;
    const query = new URLSearchParams(params).toString();
    const script = document.createElement('script');
    script.src = url + (url.indexOf('?') === -1 ? '?' : '&') + query;
    let timedOut = false;

    const cleanup = () => {
      if (script.parentNode) script.parentNode.removeChild(script);
      try { delete window[callbackName]; } catch(e) {}
      clearTimeout(timer);
    };

    window[callbackName] = (data) => {
      if (timedOut) return;
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      if (timedOut) return;
      cleanup();
      reject(new Error('Network / JSONP script error'));
    };

    document.body.appendChild(script);

    const timer = setTimeout(() => {
      timedOut = true;
      cleanup();
      reject(new Error('Request timeout'));
    }, timeoutMs);
  });
}

/* ------------- Local offline queue for clicks ------------- */
const CLICK_QUEUE_KEY = 'smartcart_click_queue';
function enqueueClick(clickObj) {
  const q = JSON.parse(localStorage.getItem(CLICK_QUEUE_KEY) || '[]');
  q.push(clickObj);
  localStorage.setItem(CLICK_QUEUE_KEY, JSON.stringify(q));
}
function dequeueAndSendClicks() {
  const q = JSON.parse(localStorage.getItem(CLICK_QUEUE_KEY) || '[]');
  if (!q.length) return Promise.resolve();
  // send sequentially
  return q.reduce((p, click) => {
    return p.then(() => sendClick(click, true).then(() => {
      const current = JSON.parse(localStorage.getItem(CLICK_QUEUE_KEY) || '[]');
      current.shift();
      localStorage.setItem(CLICK_QUEUE_KEY, JSON.stringify(current));
    }));
  }, Promise.resolve());
}

/* ------------- Session start ------------- */
document.getElementById("startSessionBtn").addEventListener("click", async () => {
  customerId = document.getElementById("customerId").value.trim();
  segment = document.getElementById("segment").value.trim();
  if (!customerId) return alert("Please enter your Customer ID.");

  try {
    const resp = await jsonpRequest(BACKEND_URL, {
      action: 'startSession',
      customerId,
      segment
    }, 9000);

    if (resp && resp.status === 'ok' && resp.sessionId) {
      sessionId = resp.sessionId;
      // show modal
      new bootstrap.Modal(document.getElementById('sessionModal')).show();
      document.getElementById("setupSection").style.display = "none";
      document.getElementById("scannerSection").style.display = "block";
      document.getElementById('liveStatus').textContent = 'Session active â€” ready to scan';
      // attempt to send any queued clicks
      dequeueAndSendClicks();
    } else {
      alert("Failed to start session: " + (resp && resp.error ? resp.error : 'unknown'));
    }
  } catch (err) {
    alert("Network error: " + err.message);
  }
});

/* ------------- QR scanner init ------------- */
let html5QrCodeInstance = null;
document.getElementById("scanQRBtn").addEventListener("click", () => {
  const readerDiv = document.getElementById("reader");
  if (!html5QrCodeInstance) {
    html5QrCodeInstance = new Html5Qrcode("reader");
  }
  document.getElementById('liveStatus').textContent = 'Scanning...';
  html5QrCodeInstance.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      // stop scanning immediately to avoid duplicates
      html5QrCodeInstance.stop().then(() => {
        document.getElementById('liveStatus').textContent = 'Scan received';
        handleQRCode(qrCodeMessage);
      });
    },
    errorMessage => {
      // scanner error - ignore noisy messages
    }
  ).catch(err => {
    alert('Unable to start camera: ' + err);
  });
});

/* ------------- Handle QR result ------------- */
async function handleQRCode(token) {
  // token is typically your shelf productId
  try {
    const resp = await jsonpRequest(BACKEND_URL, {
      action: 'getRecommendations',
      productId: token,
      sessionId: sessionId,
      customerId,
      segment
    }, 9000);

    if (resp && resp.recommendations) {
      displayProducts(resp.recommendations);
    } else {
      displayProducts([]);
    }
  } catch (err) {
    alert('QR scan failed: ' + err.message);
  }
}

/* ------------- Render product cards ------------- */
function displayProducts(products) {
  const container = document.getElementById("productList");
  container.innerHTML = "";
  if (!products || !products.length) {
    container.innerHTML = `<div class="text-center text-muted">No recommendations found for this area.</div>`;
    return;
  }

  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <h5>${escapeHtml(p.name)}</h5>
      <p class="small-muted"><b>Category:</b> ${escapeHtml(p.category || '')}</p>
      <p class="small-muted"><b>Calories:</b> ${p.calories || 0}, <b>Protein:</b> ${p.protein || 0}g, <b>Sugar:</b> ${p.sugar || 0}g</p>
      <p><b>Price:</b> à¸¿${p.price || 0}</p>
      <button class="btn btn-outline-primary w-100" data-productid="${escapeHtml(p.productId)}">Add / View Details</button>
    `;
    const btn = div.querySelector('button');
    btn.addEventListener('click', () => {
      // record click and then fetch new recommendations
      const prodId = btn.getAttribute('data-productid');
      recordClickAndRefresh(prodId);
    });
    container.appendChild(div);
  });
}

/* simple helper */
function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ------------- Record click and fetch updated recs ------------- */
async function recordClickAndRefresh(productId) {
  const clickObj = {
    action: 'recordClick',
    sessionId,
    customerId,
    productId,
    segment,
    clickAction: 'click',
    ts: new Date().toISOString()
  };

  // try send; if fails, enqueue and notify user
  try {
    const result = await sendClick(clickObj, false);
    if (result && result.recommendations) {
      displayProducts(result.recommendations);
      // small confirmation
      showToast('Product interaction recorded');
    } else {
      showToast('Recorded (no recommendations returned)');
    }
  } catch (err) {
    enqueueClick(clickObj);
    showToast('Offline â€” interaction queued');
  }
}

/* sendClick(clickObj, isFromQueue) -> returns promise resolving to backend response */
function sendClick(clickObj, fromQueue) {
  // convert clickObj to params for JSONP GET (JSONP supports GET only)
  const params = {
    action: 'recordClick',
    customerId: clickObj.customerId || '',
    sessionId: clickObj.sessionId || '',
    productId: clickObj.productId || '',
    segment: clickObj.segment || '',
    clickAction: clickObj.clickAction || 'click'
  };
  // If fromQueue use a longer timeout
  return jsonpRequest(BACKEND_URL, params, fromQueue ? 12000 : 9000);
}

/* ------------- Small toast for feedback ------------- */
function showToast(msg) {
  // simple alert-like transient UI
  const t = document.createElement('div');
  t.style.position = 'fixed';
  t.style.left = '50%';
  t.style.transform = 'translateX(-50%)';
  t.style.bottom = '90px';
  t.style.background = '#212529';
  t.style.color = '#fff';
  t.style.padding = '10px 16px';
  t.style.borderRadius = '8px';
  t.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => {
    t.style.transition = 'opacity .4s';
    t.style.opacity = '0';
    setTimeout(() => t.remove(), 450);
  }, 1500);
}

/* ------------- Attempt to flush queue on network reconnect ------------- */
window.addEventListener('online', () => {
  dequeueAndSendClicks();
});

/* ------------- Initial attempt to flush any leftover queue on load ------------- */
window.addEventListener('load', () => {
  if (navigator.onLine) dequeueAndSendClicks();
});
</script>

</body>
</html>
