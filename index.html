<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Cart WebApp</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
  .container { max-width: 500px; margin: auto; }
  button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
  .products { margin-top: 20px; }
  .product { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  .summary { background: #e0f7fa; padding: 10px; margin-top: 20px; border-radius: 6px; }
</style>
</head>
<body>
<div class="container">
  <h2>Welcome to Smart Cart</h2>
  <p>Select your segment:</p>
  <select id="segment">
    <option value="Nutrition">Nutrition / Goal Achiever</option>
    <option value="Budget">Budget Lover</option>
    <option value="Household">Household / Checklist</option>
  </select>
  <button onclick="startSession()">Start Session</button>
  
  <hr>
  <button onclick="scanQRCode()">Scan QR Code in Area</button>
  
  <div class="products" id="products"></div>
  <div class="summary" id="summary" style="display:none;"></div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
const BACKEND_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLg26TaU1rFrbL8eFBfGlzw6wUb_PxVpngps-bP4epvdQnn-r7vRI780xNKpchLsRl4lUHH8xR8VeFMWLUWXN-grFve0Oj3vo7MHrqlYqgzbXobxPzYma63XC16-OaKJBtXF28x9D8USXBpSaFQ8OYUz8vjzXElGJTaPqGGMFrVEv7Zg5qxRGrt0BzBZQ8gHQbCINYIVuSx4w2ubUIEcuku_ghMURP60qjBJ39w3p7K6D9ausG0axhMoVi6spV_FJCM2qUern_hZoMeI08AClAcVkYG0ZcN--Ra3druM&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt"; // replace with your JSONP-enabled backend URL
let customerId = null;
let segment = null;

// ---- JSONP helper ----
function jsonp(url, params, callbackName) {
  const script = document.createElement('script');
  const query = new URLSearchParams({...params, callback: callbackName}).toString();
  script.src = `${url}?${query}`;
  document.body.appendChild(script);
  script.onload = () => document.body.removeChild(script);
}

// ---- Start session ----
function startSession() {
  customerId = prompt("Enter your Customer ID");
  segment = document.getElementById('segment').value;
  if(!customerId) return alert("Please enter Customer ID");

  jsonp(BACKEND_URL, { action: "startSession", customerId, segment }, "onSessionStarted");
}

function onSessionStarted(data) {
  if(data.status === "ok") {
    alert("Session started! Scan QR codes to get recommendations.");
    fetchProducts();
  } else {
    alert("Error: " + (data.error || "Unknown"));
  }
}

// ---- QR Code scan ----
function scanQRCode() {
  const html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length) {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          fetchProducts(qrCodeMessage);
          html5QrCode.stop();
        },
        errorMessage => {}
      );
    }
  }).catch(err => alert("Camera error: " + err));
}

// ---- Fetch all products ----
function fetchProducts(zoneToken=null) {
  jsonp(BACKEND_URL, { action: "getProducts" }, "onProductsFetched");
}

function onProductsFetched(data) {
  const container = document.getElementById('products');
  container.innerHTML = "";
  data.products.forEach(p => {
    const div = document.createElement('div');
    div.className = "product";
    div.innerHTML = `
      <b>${p.name}</b> (${p.category})<br>
      Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
      Price: ${p.price}<br>
      <button onclick="recordClick('${p.productId}')">View / Click</button>
    `;
    container.appendChild(div);
  });
}

// ---- Record click ----
function recordClick(productId) {
  jsonp(BACKEND_URL, { action: "recordClick", customerId, productId, segment, action: "click" }, "onClickRecorded");
}

function onClickRecorded() {
  // After click, fetch recommendations for that product
  const lastClicked = event.target.getAttribute('onclick').match(/'(.+?)'/)[1];
  fetchRecommendations(lastClicked);
}

// ---- Fetch recommendations ----
function fetchRecommendations(productId) {
  jsonp(BACKEND_URL, { action: "getRecommendations", productId }, "onRecommendationsFetched");
}

function onRecommendationsFetched(data) {
  if(!data.recommendations || data.recommendations.length === 0) return;

  const container = document.getElementById('products');
  const recDiv = document.createElement('div');
  recDiv.innerHTML = `<h4>Recommended Products:</h4>`;
  data.recommendations.forEach(p => {
    const div = document.createElement('div');
    div.className = "product";
    div.innerHTML = `
      <b>${p.name}</b> (${p.category})<br>
      Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
      Price: ${p.price}<br>
      <button onclick="recordClick('${p.productId}')">View / Click</button>
    `;
    recDiv.appendChild(div);
  });
  container.appendChild(recDiv);
}

// ---- Fetch summary ----
function fetchSummary() {
  jsonp(BACKEND_URL, { action: "getSummary", customerId }, "onSummaryFetched");
}

function onSummaryFetched(data) {
  const sumDiv = document.getElementById('summary');
  sumDiv.style.display = "block";
  sumDiv.innerHTML = "<h4>Summary</h4>";
  if(segment === "Nutrition") {
    const n = data.summary.Nutrition;
    sumDiv.innerHTML += `Calories: ${n.calories}, Protein: ${n.protein}, Sugar: ${n.sugar}`;
  } else if(segment === "Budget") {
    sumDiv.innerHTML += `Total Spent: ${data.summary.Budget.total}`;
  } else if(segment === "Household") {
    sumDiv.innerHTML += "Checklist: " + data.summary.Household.checklist.join(", ");
  }
}
</script>

<div id="reader" style="width:100%; margin-top:20px;"></div>
</body>
</html>
