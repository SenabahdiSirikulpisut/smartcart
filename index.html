<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartCart Mobile</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #fafafa; font-family: 'Poppins', sans-serif; padding-bottom: 80px; }
  .header { background: #0078d7; color: #fff; padding: 1rem; text-align: center; }
  .product-card { border-radius: 15px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
  .btn-scan { background: #0078d7; color: #fff; width: 100%; font-weight: 600; }
  .btn-scan:hover { background: #005fa3; }
  .floating-btn { position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; }
</style>
</head>
<body>

<div class="header">
  <h4>SmartCart Zone Scanner</h4>
</div>

<div class="container mt-4">
  <!-- Setup Section -->
  <div id="setupSection" class="mb-4">
    <div class="mb-2">
      <label for="customerId" class="form-label">Enter your Customer ID</label>
      <input type="text" id="customerId" class="form-control" placeholder="e.g. C12345">
    </div>
    <div class="mb-3">
      <label for="segment" class="form-label">Choose Shopping Focus</label>
      <select id="segment" class="form-select">
        <option value="Nutrition">Nutrition Goals</option>
        <option value="Budget">Budget Saver</option>
        <option value="Household">Household Needs</option>
      </select>
    </div>
    <button id="startSessionBtn" class="btn btn-success w-100">Start My Session</button>
  </div>

  <!-- Scanner Section -->
  <div id="scannerSection" style="display:none;">
    <button id="scanQRBtn" class="btn btn-scan mb-3">ðŸ“· Scan Shelf QR</button>
    <div id="reader" style="width:100%;"></div>
  </div>

  <!-- Product List -->
  <div id="productList" class="mt-3"></div>
</div>

<!-- Popup Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="mb-3">âœ… Session Started!</h5>
      <p>Letâ€™s start shopping â€” scan QR codes around the store to see personalized recommendations!</p>
      <button class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
const BACKEND_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgZVmIU_iPnrAgkBVIr6IBMQW1j9-QuhA8Wo7WrcK1GU9CMm_we2XnX4IW5uD4RupAR83H2hmYXq275y6fETcTiHB6UavSgTkFVZwp2vKPs8L7-VtInay4Nf4xSTMteojaJYsfiEcEdt7kEHlx15GPEo1dPLXXwQDRdCpdf2hDk9e1uIYP3L6SXlAo1o_W1YU7nhzVW7oMPI0IAsrDIX6miEqaFzEl9LS9RzxOZfzdeFTcGoRnsH2GbNB8jyStOOMJ9BmG7xpyg-38SSklXmoUzsY2oVgtginH-jiDY&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt";
let customerId = "", segment = "";

// --- JSONP Loader ---
function loadJSONP(url, callbackName) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    window[callbackName] = (data) => {
      resolve(data);
      document.body.removeChild(script);
      delete window[callbackName];
    };
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = () => reject(new Error('Network error'));
    document.body.appendChild(script);
  });
}

// --- Start Session ---
document.getElementById("startSessionBtn").addEventListener("click", async () => {
  customerId = document.getElementById("customerId").value.trim();
  segment = document.getElementById("segment").value.trim();
  if (!customerId) return alert("Please enter your Customer ID.");

  try {
    const data = await loadJSONP(
      `${BACKEND_URL}?action=startSession&customerId=${encodeURIComponent(customerId)}&segment=${encodeURIComponent(segment)}`,
      'handleStartSession'
    );

    if (data.status === "ok") {
      new bootstrap.Modal(document.getElementById('sessionModal')).show();
      document.getElementById("setupSection").style.display = "none";
      document.getElementById("scannerSection").style.display = "block";
    } else {
      alert("Failed to start session: " + (data.error || "unknown"));
    }
  } catch (err) {
    alert("Network error: " + err);
  }
});

// --- Initialize QR Scanner ---
document.getElementById("scanQRBtn").addEventListener("click", () => {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async qrCodeMessage => {
      html5QrCode.stop();
      handleQRCode(qrCodeMessage);
    },
    errorMessage => {}
  );
});

// --- Handle QR Scan Result ---
async function handleQRCode(token) {
  try {
    const data = await loadJSONP(
      `${BACKEND_URL}?action=getRecommendations&productId=${encodeURIComponent(token)}`,
      'handleRecommendations'
    );
    displayProducts(data.recommendations || []);
  } catch (err) {
    alert("QR scan failed: " + err);
  }
}

// --- Display Recommended Products ---
function displayProducts(products) {
  const container = document.getElementById("productList");
  container.innerHTML = "";
  if (!products.length) {
    container.innerHTML = `<div class="text-center text-muted">No products found for this area.</div>`;
    return;
  }

  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <h5>${p.name}</h5>
      <p><b>Category:</b> ${p.category}</p>
      <p><b>Calories:</b> ${p.calories}, <b>Protein:</b> ${p.protein}g, <b>Sugar:</b> ${p.sugar}g</p>
      <p><b>Price:</b> à¸¿${p.price}</p>
      <button class="btn btn-outline-primary w-100" onclick="recordClick('${p.productId}')">Add / View Details</button>
    `;
    container.appendChild(div);
  });
}

// --- Record Click ---
function recordClick(productId) {
  const params = new URLSearchParams({
    action: 'recordClick',
    customerId,
    productId,
    segment,
    clickAction: 'click' // avoid duplicate 'action'
  }).toString();

  const callbackName = 'handleRecordClick_' + Date.now();
  loadJSONP(`${BACKEND_URL}?${params}`, callbackName)
    .then(() => alert("Product interaction recorded!"))
    .catch(err => alert("Failed to record click: " + err));
}
</script>

</body>
</html>
