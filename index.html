<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Cart WebApp</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
  .container { max-width: 500px; margin: auto; }
  button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
  .products { margin-top: 20px; }
  .product { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  .summary { background: #e0f7fa; padding: 10px; margin-top: 20px; border-radius: 6px; }
</style>
</head>
<body>
<div class="container">
  <h2>Welcome to Smart Cart</h2>
  <p>Select your segment:</p>
  <select id="segment">
    <option value="Nutrition">Nutrition / Goal Achiever</option>
    <option value="Budget">Budget Lover</option>
    <option value="Household">Household / Checklist</option>
  </select>
  <button onclick="startSession()">Start Session</button>
  
  <hr>
  <button onclick="scanQRCode()">Scan QR Code in Area</button>
  
  <div class="products" id="products"></div>
  
  <div class="summary" id="summary" style="display:none;"></div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
const BACKEND_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiT_Zot_JyxxaoqfmFLt0ryKVV5m5GaqL71xgqlxiM6a1-r_KG5c5VNu8wt7Xkh8Sofs8lfm4WmQp0ZDAQjOt_XtZilCAMrjyu3LNwPlN9YKz3ExMunsho_AMN-u2-GFyk4JD5w6zH5H7J9H9W8jgbnqPKn7DCSeJu0wHKKHJuNurenI24vsQFmkO9n-cvxzldynJFpqq9qnzs4QILXZIcI2McPs3lwnmJvKFLSvjfao9RdCXEWkwzI1in_KXTTEU98i6nGVnEPuB-z9dtq0CMUJ2aqZH45BtAHWkqe&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt"; // replace with your webapp URL
let customerId = null;
let segment = null;

// ---- Start session ----
function startSession() {
  customerId = prompt("Enter your Customer ID");
  segment = document.getElementById('segment').value;
  
  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify({ action: "startSession", customerId, segment }),
  })
  .then(r => r.json())
  .then(data => {
    alert("Session started! Scan QR codes to get recommendations.");
  });
}

// ---- QR Code scan ----
function scanQRCode() {
  const html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          // QR code scanned, fetch products in this zone
          fetchProducts(qrCodeMessage);
          html5QrCode.stop();
        },
        errorMessage => {}
      );
    }
  }).catch(err => alert("Camera error: " + err));
}

// ---- Fetch products for QR zone ----
function fetchProducts(zoneToken) {
  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getProducts" }),
  })
  .then(r => r.json())
  .then(data => {
    const container = document.getElementById('products');
    container.innerHTML = "";
    
    data.products.forEach(p => {
      const div = document.createElement('div');
      div.className = "product";
      div.innerHTML = `
        <b>${p.name}</b> (${p.category})<br>
        Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
        Price: ${p.price}<br>
        <button onclick="recordClick('${p.productId}')">View / Click</button>
      `;
      container.appendChild(div);
    });
  });
}

// ---- Record click and fetch recommendations ----
function recordClick(productId) {
  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify({ action: "recordClick", customerId, productId, segment, action:"click" }),
  })
  .then(() => fetchRecommendations(productId));
}

// ---- Fetch recommendations ----
function fetchRecommendations(productId) {
  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getRecommendations", productId }),
  })
  .then(r => r.json())
  .then(data => {
    if (!data.recommendations || data.recommendations.length === 0) return;
    const container = document.getElementById('products');
    const recDiv = document.createElement('div');
    recDiv.innerHTML = `<h4>Recommended Products:</h4>`;
    data.recommendations.forEach(p => {
      const div = document.createElement('div');
      div.className = "product";
      div.innerHTML = `
        <b>${p.name}</b> (${p.category})<br>
        Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
        Price: ${p.price}<br>
        <button onclick="recordClick('${p.productId}')">View / Click</button>
      `;
      recDiv.appendChild(div);
    });
    container.appendChild(recDiv);
  });
}

// ---- Fetch summary ----
function fetchSummary() {
  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getSummary", customerId }),
  })
  .then(r => r.json())
  .then(data => {
    const sumDiv = document.getElementById('summary');
    sumDiv.style.display = "block";
    sumDiv.innerHTML = "<h4>Summary</h4>";
    if (segment === "Nutrition") {
      const n = data.summary.Nutrition;
      sumDiv.innerHTML += `Calories: ${n.calories}, Protein: ${n.protein}, Sugar: ${n.sugar}`;
    } else if (segment === "Budget") {
      sumDiv.innerHTML += `Total Spent: ${data.summary.Budget.total}`;
    } else if (segment === "Household") {
      sumDiv.innerHTML += "Checklist: " + data.summary.Household.checklist.join(", ");
    }
  });
}
</script>
