<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SmartCart</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script defer src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
  body { background-color: #f8f9fa; padding: 1rem; }
  #reader, #debugVideo { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 1rem; overflow: hidden; display:none; }
  .product-card { transition: transform 0.2s ease-in-out; margin-bottom: 1rem; }
  .product-card:hover { transform: scale(1.03); }
</style>
</head>
<body class="container py-4">

<h2 class="text-center mb-4">🛒 SmartCart</h2>

<!-- Login Section -->
<div id="loginSection" class="card p-3 shadow-sm">
  <div class="mb-3">
    <label class="form-label">Customer ID</label>
    <input type="text" id="customerId" class="form-control" placeholder="Enter your ID" />
  </div>
  <div class="mb-3">
    <label class="form-label">Shopping Focus</label>
    <select id="focus" class="form-select">
      <option value="Nutrition">Nutrition</option>
      <option value="Budget">Budget</option>
      <option value="Household">Household</option>
    </select>
  </div>
  <button id="startSession" class="btn btn-primary w-100">Start Session</button>
</div>

<!-- Main Screen after Session Start -->
<div id="mainScreen" class="d-none mt-4">
  <div class="d-flex justify-content-between mb-3">
    <button id="scanQRBtn" class="btn btn-success">Scan QR in Zones</button>
    <button id="viewSummaryBtn" class="btn btn-info">View Summary</button>
  </div>

  <div id="reader" class="shadow"></div>

  <div id="recommendationsSection" class="mt-4 d-none">
    <h5>Recommended Products</h5>
    <div id="recommendations" class="row g-3"></div>
  </div>

  <div id="summarySection" class="mt-4 d-none">
    <h5>Session Summary</h5>
    <div id="summaryContent" class="card p-3 shadow-sm"></div>
  </div>

  <!-- Camera Debug Panel -->
  <div class="mt-4 card p-3 shadow-sm">
    <h5>Camera Debug / Test Mode</h5>
    <select id="debugCameraFacing" class="form-select mb-2">
      <option value="environment">Rear (Environment)</option>
      <option value="user">Front</option>
    </select>
    <button id="debugStartQr" class="btn btn-primary w-100 mb-2">Start QR Scan Test</button>
    <button id="debugStopQr" class="btn btn-danger w-100 mb-2">Stop QR Scan Test</button>
    <button id="debugStartDirect" class="btn btn-secondary w-100 mb-2">Start Direct Camera Test</button>
    <video id="debugVideo" autoplay muted playsinline class="border shadow-sm mt-2"></video>
    <pre id="debugLog" style="height:150px; overflow:auto; background:#f1f1f1; padding:5px;"></pre>
  </div>
</div>

<!-- Session Confirmation Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <h5>✅ Session Started</h5>
        <p>Welcome! Press "Scan QR in Zones" to begin exploring product recommendations.</p>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
      </div>
    </div>
  </div>
</div>

<script defer>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxfGHWQWxeMyQyi40iYq9vWRO1tSfl0ADSN-mOflDamZ5YrGR5HCGI6Dy0Ga45Nf-0Dsw/exec";
let html5QrCode, debugQr, debugStream;
let customerId = "", focus = "";

// Elements
const loginSection = document.getElementById("loginSection");
const mainScreen = document.getElementById("mainScreen");
const scanQRBtn = document.getElementById("scanQRBtn");
const viewSummaryBtn = document.getElementById("viewSummaryBtn");
const readerDiv = document.getElementById("reader");
const recommendationsSection = document.getElementById("recommendationsSection");
const recommendationsContainer = document.getElementById("recommendations");
const summarySection = document.getElementById("summarySection");
const summaryContent = document.getElementById("summaryContent");

// Debug elements
const debugLogElem = document.getElementById("debugLog");
const debugVideo = document.getElementById("debugVideo");

// Utility: debug log
const debugLog = msg => { debugLogElem.textContent += msg + "\n"; debugLogElem.scrollTop = debugLogElem.scrollHeight; console.log(msg); }

window.addEventListener("DOMContentLoaded", () => {
  // Start Session
  document.getElementById("startSession").addEventListener("click", async () => {
    customerId = document.getElementById("customerId").value.trim();
    focus = document.getElementById("focus").value;
    if (!customerId) return alert("Please enter Customer ID.");

    try {
      await jsonp(`${BACKEND_URL}?action=startSession&customerId=${customerId}&focus=${focus}`);
      loginSection.classList.add("d-none");
      mainScreen.classList.remove("d-none");
      const sessionModal = new bootstrap.Modal(document.getElementById("sessionModal"));
      sessionModal.show();
    } catch (err) {
      console.error(err);
      alert("Failed to start session. Please check your connection.");
    }
  });

  scanQRBtn.addEventListener("click", () => startScanner());
  viewSummaryBtn.addEventListener("click", () => loadSummary());

  // Debug / Camera Test
  document.getElementById("debugStartQr").addEventListener("click", startDebugQr);
  document.getElementById("debugStopQr").addEventListener("click", stopDebugQr);
  document.getElementById("debugStartDirect").addEventListener("click", startDirectCamera);

  // Enumerate cameras
  navigator.mediaDevices.enumerateDevices()
    .then(devices => devices.forEach(d => debugLog(`${d.kind}: ${d.label || d.deviceId}`)))
    .catch(err => debugLog("❌ enumerateDevices error: " + err));
});

// === Main QR Scanner ===
async function startScanner() {
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  readerDiv.style.display = "block";
  scanQRBtn.disabled = true;

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async (decodedText) => {
      await html5QrCode.stop();
      html5QrCode.clear();
      readerDiv.style.display = "none";
      scanQRBtn.disabled = false;

      const recs = await fetchRecommendations(decodedText);
      displayProducts(recs);
    },
    (err) => {}
  );
}

// === Fetch Recommendations ===
async function fetchRecommendations(token) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Date.now();
    window[callbackName] = (data) => { delete window[callbackName]; resolve(data.recommendations || []); };
    const script = document.createElement("script");
    script.src = `${BACKEND_URL}?action=getRecommendations&productId=${encodeURIComponent(token)}&customerId=${customerId}&focus=${focus}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// === Record Click & Fetch Next ===
async function recordClickAndFetchNext(productId) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Date.now();
    window[callbackName] = (data) => { delete window[callbackName]; resolve(data.recommendations || []); };
    const script = document.createElement("script");
    script.src = `${BACKEND_URL}?action=recordClick&customerId=${customerId}&productId=${productId}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// === Display Products ===
function displayProducts(products) {
  recommendationsSection.classList.remove("d-none");
  recommendationsContainer.innerHTML = "";
  if (!products.length) { recommendationsContainer.innerHTML = `<p class="text-muted">No recommendations found.</p>`; return; }

  products.forEach(p => {
    const card = document.createElement("div");
    card.className = "col-md-4 product-card";
    card.innerHTML = `
      <div class="card h-100 shadow-sm text-center p-2">
        <h6>${p.name}</h6>
        <p class="small text-muted">${p.category}</p>
        <button class="btn btn-outline-primary btn-sm">View / Add</button>
      </div>
    `;
    card.querySelector("button").addEventListener("click", async () => {
      const recs = await recordClickAndFetchNext(p.productId);
      displayProducts(recs);
    });
    recommendationsContainer.appendChild(card);
  });
}

// === Load Summary ===
function loadSummary() {
  jsonp(`${BACKEND_URL}?action=getSummary&customerId=${customerId}`).then(data => {
    summarySection.classList.remove("d-none");
    const s = data.summary[customerId] || {};
    summaryContent.innerHTML = `
      <p><strong>Nutrition:</strong> Calories ${s.Nutrition?.calories || 0}, Protein ${s.Nutrition?.protein || 0}, Sugar ${s.Nutrition?.sugar || 0}</p>
      <p><strong>Budget:</strong> ${s.Budget?.total || 0}</p>
      <p><strong>Household:</strong> ${s.Household?.checklist?.join(", ") || "None"}</p>
    `;
  });
}

// === JSONP Helper ===
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const callbackName = "jsonp_callback_" + Math.round(100000 * Math.random());
    window[callbackName] = (data) => { delete window[callbackName]; document.body.removeChild(script); resolve(data); };
    const script = document.createElement("script");
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// === Debug / Camera Test Functions ===
async function startDebugQr() {
  const facing = document.getElementById("debugCameraFacing").value;
  if (typeof Html5Qrcode === "undefined") { debugLog("❌ Html5Qrcode undefined!"); return; }
  if (!debugQr) debugQr = new Html5Qrcode("reader");
  readerDiv.style.display = "block";
  debugQr.start(
    { facingMode: facing },
    { fps: 10, qrbox: 250 },
    decoded => debugLog("✅ QR Scanned: " + decoded),
    err => {}
  ).then(() => debugLog("✅ Html5Qrcode started with facingMode=" + facing))
  .catch(err => debugLog("❌ Html5Qrcode start error: " + err));
}

async function stopDebugQr() {
  if (debugQr) { await debugQr.stop(); debugQr.clear(); readerDiv.style.display = "none"; debugLog("Stopped Html5Qrcode test."); }
  if (debugStream) { debugStream.getTracks().forEach(track => track.stop()); debugVideo.srcObject = null; debugLog("Stopped direct video stream."); }
}

async function startDirectCamera() {
  const facing = document.getElementById("debugCameraFacing").value;
  try { debugStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } }); debugVideo.srcObject = debugStream; debugVideo.style.display="block"; debugLog("✅ getUserMedia started with facingMode=" + facing); }
  catch(err){ debugLog("❌ getUserMedia error: " + err); }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
