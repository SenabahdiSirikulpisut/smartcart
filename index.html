<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartCart — Fixed + Troubleshooting</title>

<!-- Tiny data-icon to avoid favicon 404 -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='26' font-size='26'%3E%F0%9F%8D%90%3C/text%3E%3C/svg%3E">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { background: #f8f9fa; padding: 1rem; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  #reader, #debugVideo { width: 100%; max-width: 420px; margin: 0 auto 1rem auto; border-radius: 12px; overflow:hidden; display:none; background:#000; }
  .product-card { transition: transform .14s ease-in-out; }
  .product-card:hover { transform: translateY(-4px); }
  #troubleshootLog { height:160px; overflow:auto; background:#fff; border:1px solid #eee; padding:.5rem; font-size:.875rem; }
  .muted-small { font-size:.85rem; color:#6c757d; }
</style>
</head>
<body class="container py-4">

<h2 class="text-center mb-3">🛒 SmartCart — Camera + Debug</h2>

<!-- Login Section -->
<div id="loginSection" class="card p-3 mb-3 shadow-sm">
  <div class="mb-2">
    <label class="form-label">Customer ID</label>
    <input id="customerId" class="form-control" placeholder="e.g. C12345" />
  </div>
  <div class="mb-2">
    <label class="form-label">Shopping Focus</label>
    <select id="focus" class="form-select">
      <option>Nutrition</option>
      <option>Budget</option>
      <option>Household</option>
    </select>
  </div>
  <button id="startSession" class="btn btn-primary w-100">Start Session</button>
  <div class="mt-2 muted-small">After starting a session you'll see a blank main screen with Scan + Summary.</div>
</div>

<!-- Main Screen -->
<div id="mainScreen" class="d-none">
  <div class="d-flex gap-2 mb-3">
    <button id="scanQRBtn" class="btn btn-success flex-grow-1">Scan QR in Zones</button>
    <button id="viewSummaryBtn" class="btn btn-info">View Summary</button>
  </div>

  <div id="reader" class="shadow"></div>

  <div id="recommendationsSection" class="mt-3 d-none">
    <h5>Recommended Products</h5>
    <div id="recommendations" class="row g-3"></div>
  </div>

  <div id="summarySection" class="mt-3 d-none">
    <h5>Session Summary</h5>
    <div id="summaryContent" class="card p-3"></div>
  </div>

  <!-- Troubleshooting panel -->
  <div class="card mt-4 p-3">
    <h6>Camera Troubleshooting</h6>
    <div class="d-flex gap-2 mb-2">
      <button id="btnCheckLib" class="btn btn-outline-secondary btn-sm">Check QR Library</button>
      <button id="btnEnum" class="btn btn-outline-secondary btn-sm">List Cameras</button>
      <button id="btnGetUserMedia" class="btn btn-outline-secondary btn-sm">Test Camera (getUserMedia)</button>
      <button id="btnTryAll" class="btn btn-outline-primary btn-sm">Try All Camera Options</button>
    </div>

    <div id="debugVideo" class="mb-2"></div>

    <div id="troubleshootLog" class="mb-2"></div>

    <div class="muted-small">
      <strong>Common errors explained:</strong>
      <ul>
        <li><em>Html5Qrcode not defined</em> — library didn't load. Use stable CDN or dynamic load.</li>
        <li><em>Permission denied</em> — user blocked camera; clear site permissions and retry (HTTPS required).</li>
        <li><em>No video devices</em> — browser can't see cameras (driver or system problem).</li>
        <li><em>Mixed content</em> — page served over HTTP but device blocks camera (use HTTPS / localhost).</li>
      </ul>
    </div>
  </div>
</div>

<!-- Session confirmation modal (we'll blur focus before showing to avoid aria-hidden focus warning) -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3 text-center">
      <h5 class="mb-2">✅ Session Started</h5>
      <p class="mb-3">You're good to go — press <strong>Scan QR in Zones</strong> to open the camera.</p>
      <button class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
    </div>
  </div>
</div>

<!-- Load bootstrap JS at end -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ======= Configuration & Backend URL ======= */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxfGHWQWxeMyQyi40iYq9vWRO1tSfl0ADSN-mOflDamZ5YrGR5HCGI6Dy0Ga45Nf-0Dsw/exec";

/* ======= UI refs ======= */
const loginSection = document.getElementById('loginSection');
const mainScreen = document.getElementById('mainScreen');
const startSessionBtn = document.getElementById('startSession');
const scanQRBtn = document.getElementById('scanQRBtn');
const viewSummaryBtn = document.getElementById('viewSummaryBtn');
const readerDiv = document.getElementById('reader');
const recommendationsSection = document.getElementById('recommendationsSection');
const recommendationsContainer = document.getElementById('recommendations');
const summarySection = document.getElementById('summarySection');
const summaryContent = document.getElementById('summaryContent');

const btnCheckLib = document.getElementById('btnCheckLib');
const btnEnum = document.getElementById('btnEnum');
const btnGetUserMedia = document.getElementById('btnGetUserMedia');
const btnTryAll = document.getElementById('btnTryAll');
const debugVideo = document.getElementById('debugVideo');
const logBox = document.getElementById('troubleshootLog');

let html5QrCode = null;
let customerId = '';
let focus = '';

/* ======= Logging helpers with mapped troubleshooting messages ======= */
function log(msg, type='info') {
  const ts = new Date().toLocaleTimeString();
  const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : 'ℹ️';
  logBox.textContent += `[${ts}] ${prefix} ${msg}\n`;
  logBox.scrollTop = logBox.scrollHeight;
  console[type === 'error' ? 'error' : type === 'warn' ? 'warn' : 'log'](msg);
}

function explainError(err) {
  // Map likely errors to helpful messages
  if (!err) return '';
  const s = String(err).toLowerCase();
  if (s.includes('not allowed') || s.includes('permission')) {
    return 'Permission denied: user blocked camera. Ask user to allow camera in site settings (site must be HTTPS or localhost).';
  }
  if (s.includes('not found') || s.includes('could not start')) {
    return 'No accessible camera: try different facingMode (user/environment), check OS camera settings and drivers.';
  }
  if (s.includes('http') && s.includes('denied')) {
    return 'Mixed content or insecure context: page must be served over HTTPS (or localhost) to access camera.';
  }
  if (s.includes('html5qrcode') || s.includes('not defined')) {
    return 'QR library missing; try reloading or use stable CDN (jsdelivr).';
  }
  return null;
}

/* ======= JSONP helper (used by your backend) ======= */
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const callbackName = 'cb_' + Math.round(Math.random()*1e9);
    window[callbackName] = (data) => { delete window[callbackName]; script.remove(); resolve(data); };
    const script = document.createElement('script');
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = (e) => { script.remove(); reject(new Error('Network/script load error')); };
    document.body.appendChild(script);
  });
}

/* ======= Session Start ======= */
startSessionBtn.addEventListener('click', async () => {
  customerId = document.getElementById('customerId').value.trim();
  focus = document.getElementById('focus').value;
  if (!customerId) { alert('Please enter Customer ID.'); return; }

  try {
    await jsonp(`${BACKEND_URL}?action=startSession&customerId=${encodeURIComponent(customerId)}&segment=${encodeURIComponent(focus)}`);
    // blur any active element to avoid aria-hidden focus warning when modal appears
    if (document.activeElement) try { document.activeElement.blur(); } catch(e){/* ignore */ }
    loginSection.classList.add('d-none');
    mainScreen.classList.remove('d-none');
    const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
    modal.show();
    log('Session started successfully.');
  } catch (err) {
    log('Failed to start session: ' + err, 'error');
    alert('Failed to start session. Check network and backend URL.');
  }
});

/* ======= Scan QR: reuse the working camera formula and robust checks ======= */
scanQRBtn.addEventListener('click', () => startScannerTryAll());

async function startScannerTryAll() {
  // ensure the html5-qrcode library is loaded; try to dynamically load if not present
  if (typeof Html5Qrcode === 'undefined') {
    log('Html5Qrcode not present — attempting dynamic load from jsDelivr...');
    try {
      await loadScript('https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js', 8000);
      log('Html5Qrcode loaded dynamically.');
    } catch (err) {
      log('Failed to load html5-qrcode library: ' + err, 'error');
      const expl = explainError(err) || 'Library load failed. Check network or CDN.';
      alert('Cannot start scanner: ' + expl);
      return;
    }
  }

  // create scanner once
  if (!html5QrCode) html5QrCode = new Html5Qrcode(/* element id */ 'reader');

  readerDiv.style.display = 'block';
  scanQRBtn.disabled = true;

  // list of camera constraints to try (proven working formula)
  const cameraOptions = [
    { facingMode: 'environment' },
    { facingMode: 'user' },
    // fallback to default device if both facingMode constraints fail
    {}
  ];

  for (let opt of cameraOptions) {
    try {
      log('Trying camera option: ' + JSON.stringify(opt));
      await html5QrCode.start(
        opt,
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          // single-scan mode: stop immediately
          try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e){/* ignore */ }
          readerDiv.style.display = 'none';
          scanQRBtn.disabled = false;
          log('QR code scanned: ' + decodedText);
          try {
            const recs = await fetchRecommendations(decodedText);
            displayProducts(recs);
          } catch (e) {
            log('Failed fetching recommendations: ' + e, 'error');
          }
        },
        (scanErr) => {
          // scanning in progress — not an immediate failure
          // we ignore per-frame errors
        }
      );
      log('Camera started successfully with option: ' + JSON.stringify(opt));
      // if successful, exit the try loop (scanner is running until it finds QR)
      return;
    } catch (err) {
      const explanation = explainError(err) || 'Camera start failed for this option.';
      log(`Camera option failed (${JSON.stringify(opt)}): ${err} — ${explanation}`, 'warn');
      // try next constraint
      continue;
    }
  }

  // if reached here, no camera started
  log('All camera options failed — unable to start scanner.', 'error');
  alert('Unable to access any camera. See Troubleshooting log for suggestions.');
  scanQRBtn.disabled = false;
}

/* Helper: dynamic script loader with timeout */
function loadScript(src, timeout = 5000) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    let settled = false;
    const to = setTimeout(() => {
      if (!settled) { settled = true; s.remove(); reject(new Error('Script load timeout')); }
    }, timeout);
    s.onload = () => { if (!settled) { settled = true; clearTimeout(to); resolve(); } };
    s.onerror = (e) => { if (!settled) { settled = true; clearTimeout(to); s.remove(); reject(new Error('Script load error')); } };
    s.src = src;
    document.body.appendChild(s);
  });
}

/* ======= Recommendations / backend calls (JSONP) ======= */
function fetchRecommendations(token) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.round(Math.random()*1e9);
    window[cb] = (data) => { delete window[cb]; resolve(data.recommendations || []); };
    const script = document.createElement('script');
    script.src = `${BACKEND_URL}?action=getRecommendations&productId=${encodeURIComponent(token)}&customerId=${encodeURIComponent(customerId)}&segment=${encodeURIComponent(focus)}&callback=${cb}`;
    script.onerror = (e) => { script.remove(); reject(new Error('Network or backend error')); };
    document.body.appendChild(script);
  });
}

function recordClickAndFetchNext(productId) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.round(Math.random()*1e9);
    window[cb] = (data) => { delete window[cb]; resolve(data.recommendations || []); };
    const script = document.createElement('script');
    script.src = `${BACKEND_URL}?action=recordClick&customerId=${encodeURIComponent(customerId)}&productId=${encodeURIComponent(productId)}&segment=${encodeURIComponent(focus)}&callback=${cb}`;
    script.onerror = (e) => { script.remove(); reject(new Error('Network or backend error')); };
    document.body.appendChild(script);
  });
}

/* ======= UI for product list ======= */
function displayProducts(products) {
  recommendationsSection.classList.remove('d-none');
  recommendationsContainer.innerHTML = '';
  if (!products || products.length === 0) {
    recommendationsContainer.innerHTML = '<div class="text-muted">No recommendations found for this zone.</div>';
    return;
  }
  for (const p of products) {
    const col = document.createElement('div');
    col.className = 'col-md-4 product-card';
    col.innerHTML = `
      <div class="card h-100 shadow-sm p-2 text-center">
        <h6>${escapeHtml(p.name || 'Unnamed')}</h6>
        <p class="small text-muted mb-2">${escapeHtml(p.category || '')}</p>
        <button class="btn btn-outline-primary btn-sm">View / Add</button>
      </div>`;
    col.querySelector('button').addEventListener('click', async () => {
      try {
        const recs = await recordClickAndFetchNext(p.productId);
        displayProducts(recs);
      } catch (err) {
        log('Error recording click: ' + err, 'error');
      }
    });
    recommendationsContainer.appendChild(col);
  }
}

/* ======= Summary load ======= */
viewSummaryBtn.addEventListener('click', () => loadSummary());
function loadSummary() {
  jsonp(`${BACKEND_URL}?action=getSummary&customerId=${encodeURIComponent(customerId)}`)
    .then(data => {
      summarySection.classList.remove('d-none');
      const s = data.summary && data.summary[customerId] || {};
      summaryContent.innerHTML = `
        <p><strong>Nutrition:</strong> Calories ${s.Nutrition?.calories || 0}, Protein ${s.Nutrition?.protein || 0}, Sugar ${s.Nutrition?.sugar || 0}</p>
        <p><strong>Budget:</strong> ฿${(s.Budget?.total || 0).toFixed ? (s.Budget.total).toFixed(2) : (s.Budget?.total||0)}</p>
        <p><strong>Household:</strong> ${(s.Household?.checklist?.join(', ') || 'None')}</p>
      `;
    })
    .catch(err => {
      log('Failed to load summary: ' + err, 'error');
      alert('Could not load summary. Check network.');
    });
}

/* Small helper to escape HTML when building DOM from data */
function escapeHtml(s = '') {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ======= Troubleshooting buttons functionality ======= */
btnCheckLib.addEventListener('click', () => {
  if (typeof Html5Qrcode !== 'undefined') {
    log('Html5Qrcode is loaded and available.');
  } else {
    log('Html5Qrcode is NOT present.', 'warn');
    log('You can try dynamic load — press "Try All Camera Options" or reload the page.', 'info');
  }
});

btnEnum.addEventListener('click', async () => {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    if (cams.length === 0) log('No video input devices found. Ensure camera is connected and allowed.');
    cams.forEach((c,i) => log(`Camera #${i+1}: ${c.label || c.deviceId}`));
  } catch (err) {
    log('enumerateDevices error: ' + err, 'error');
    const expl = explainError(err) || '';
    log(expl, 'info');
  }
});

btnGetUserMedia.addEventListener('click', async () => {
  // quick getUserMedia test (shows feed in debugVideo)
  debugVideo.style.display = 'block';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const v = document.createElement('video');
    v.autoplay = true; v.playsInline = true; v.muted = true;
    v.srcObject = stream;
    debugVideo.innerHTML = '';
    debugVideo.appendChild(v);
    log('getUserMedia success — preview running. This proves camera access works.');
  } catch (err) {
    log('getUserMedia error: ' + err, 'error');
    const expl = explainError(err);
    if (expl) log('Suggested fix: ' + expl, 'info');
  }
});

btnTryAll.addEventListener('click', () => startScannerTryAll());

/* ======= Utility JSONP wrapper used by summary etc. (safe) ======= */
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.round(Math.random()*1e9);
    window[cb] = (data) => { delete window[cb]; resolve(data); };
    const script = document.createElement('script');
    script.src = `${url}${url.includes('?') ? '&' : '?'}callback=${cb}`;
    script.onerror = () => { script.remove(); reject(new Error('JSONP script load error')); };
    document.body.appendChild(script);
  });
}

</script>
</body>
</html>


