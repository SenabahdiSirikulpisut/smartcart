<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { background-color: #f8f9fa; padding: 1rem; }
    #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 1rem; overflow: hidden; }
    .product-card { transition: transform 0.2s ease-in-out; }
    .product-card:hover { transform: scale(1.03); }
    .summary-card { margin-top: 1rem; }
  </style>
</head>
<body class="container py-4">
  <h2 class="text-center mb-4">ðŸ›’ SmartCart</h2>

  <!-- Login Section -->
  <div id="loginSection" class="card p-3 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Customer ID</label>
      <input type="text" id="customerId" class="form-control" placeholder="Enter your ID" />
    </div>
    <div class="mb-3">
      <label class="form-label">Shopping Focus</label>
      <select id="focus" class="form-select">
        <option value="Nutrition">Nutrition</option>
        <option value="Budget">Budget</option>
        <option value="Household">Household</option>
      </select>
    </div>
    <button id="startSession" class="btn btn-primary w-100">Start Session</button>
  </div>

  <!-- Scanner Section -->
  <div id="scannerSection" class="text-center d-none mt-4">
    <h5>Scan Product QR Code</h5>
    <div id="reader" class="shadow"></div>
    <button id="stopScan" class="btn btn-danger mt-3">Stop Scanning</button>
  </div>

  <!-- Recommendations Section -->
  <div id="recommendationsSection" class="mt-4 d-none">
    <h5>Recommended for You</h5>
    <div id="recommendations" class="row g-3"></div>
  </div>

  <!-- Session Summary Section -->
  <div id="summarySection" class="mt-4 d-none">
    <h5>Session Summary</h5>
    <div class="row">
      <div class="col-md-4 summary-card">
        <div class="card p-2 shadow-sm text-center">
          <h6>Nutrition</h6>
          <p>Calories: <span id="calories">0</span></p>
          <p>Protein: <span id="protein">0</span>g</p>
          <p>Sugar: <span id="sugar">0</span>g</p>
        </div>
      </div>
      <div class="col-md-4 summary-card">
        <div class="card p-2 shadow-sm text-center">
          <h6>Budget</h6>
          <p>Total Spent: $<span id="budgetTotal">0</span></p>
        </div>
      </div>
      <div class="col-md-4 summary-card">
        <div class="card p-2 shadow-sm text-center">
          <h6>Household</h6>
          <ul id="householdList" class="list-unstyled"></ul>
        </div>
      </div>
    </div>
  </div>

  <script defer>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxfGHWQWxeMyQyi40iYq9vWRO1tSfl0ADSN-mOflDamZ5YrGR5HCGI6Dy0Ga45Nf-0Dsw/exec";

    const loginSection = document.getElementById("loginSection");
    const scannerSection = document.getElementById("scannerSection");
    const recommendationsSection = document.getElementById("recommendationsSection");
    const recommendationsContainer = document.getElementById("recommendations");
    const summarySection = document.getElementById("summarySection");
    const caloriesEl = document.getElementById("calories");
    const proteinEl = document.getElementById("protein");
    const sugarEl = document.getElementById("sugar");
    const budgetEl = document.getElementById("budgetTotal");
    const householdListEl = document.getElementById("householdList");

    let html5QrCode;
    let customerId = "";
    let focus = "";
    let sessionId = "";

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startSession").addEventListener("click", async () => {
        customerId = document.getElementById("customerId").value.trim();
        focus = document.getElementById("focus").value;
        if(!customerId) return alert("Please enter Customer ID.");
        await startSession(customerId, focus);
      });

      document.getElementById("stopScan").addEventListener("click", async () => {
        if(html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
        }
        scannerSection.classList.add("d-none");
        loginSection.classList.remove("d-none");
        summarySection.classList.add("d-none");
      });
    });

    // === JSONP Helper ===
    function jsonp(url){
      return new Promise((resolve, reject) => {
        const callbackName = "jsonp_callback_" + Math.round(100000 * Math.random());
        window[callbackName] = (data) => { delete window[callbackName]; script.remove(); resolve(data); };
        const script = document.createElement("script");
        script.src = url + "&callback=" + callbackName;
        script.onerror = () => { reject("JSONP failed"); };
        document.body.appendChild(script);
      });
    }

    // === Start Session ===
    async function startSession(customerId, focus){
      try{
        const data = await jsonp(`${BACKEND_URL}?action=startSession&customerId=${customerId}&segment=${focus}`);
        if(!data.sessionId) throw "No session returned";
        sessionId = data.sessionId;
        loginSection.classList.add("d-none");
        scannerSection.classList.remove("d-none");
        summarySection.classList.remove("d-none");
        startScanner();
        updateSummary(); // fetch initial summary
      } catch(err){
        console.error(err);
        alert("Failed to start session. Please check your connection.");
      }
    }

    // === QR Scanner ===
    async function startScanner(){
      html5QrCode = new Html5Qrcode("reader");
      const config = { fps:10, qrbox:250 };
      try{
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            console.log("âœ… Scanned:", decodedText);
            await handleScan(decodedText);
          },
          (errorMsg)=>{}
        );
      } catch(err){
        console.error("QR Scanner Error:", err);
        alert("Unable to access camera. Please allow permissions or reload.");
      }
    }

    // === Handle QR Scan ===
    async function handleScan(productCode){
      try{
        // Record click
        await jsonp(`${BACKEND_URL}?action=recordClick&customerId=${customerId}&sessionId=${sessionId}&productId=${productCode}&segment=${focus}`);
        updateSummary();
        const recData = await jsonp(`${BACKEND_URL}?action=getRecommendations&productId=${productCode}&sessionId=${sessionId}&segment=${focus}`);
        showRecommendations(recData.recommendations || []);
      } catch(err){
        console.error("Error handling scan:", err);
      }
    }

    // === Show Recommendations ===
    function showRecommendations(products){
      recommendationsSection.classList.remove("d-none");
      recommendationsContainer.innerHTML = "";
      if(!products.length){
        recommendationsContainer.innerHTML = `<p class="text-muted">No recommendations found.</p>`;
        return;
      }
      products.forEach(p=>{
        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="card product-card h-100 shadow-sm">
            <div class="card-body text-center">
              <h6>${p.name || "Unnamed Product"}</h6>
              <p class="small text-muted">${p.category || ""}</p>
              <button class="btn btn-outline-primary btn-sm" data-id="${p.productId}">View</button>
            </div>
          </div>
        `;
        card.querySelector("button").addEventListener("click", ()=>recordClick(p.productId));
        recommendationsContainer.appendChild(card);
      });
    }

    // === Record Click ===
    async function recordClick(productId){
      try{
        await jsonp(`${BACKEND_URL}?action=recordClick&customerId=${customerId}&sessionId=${sessionId}&productId=${productId}&segment=${focus}`);
        updateSummary();
        console.log("Click recorded:", productId);
      } catch(err){
        console.error("Error recording click:", err);
      }
    }

    // === Update Session Summary ===
    async function updateSummary(){
      try{
        const data = await jsonp(`${BACKEND_URL}?action=getSummary&customerId=${customerId}`);
        const summary = data.summary && data.summary[customerId];
        if(!summary) return;
        caloriesEl.textContent = summary.Nutrition.calories;
        proteinEl.textContent = summary.Nutrition.protein;
        sugarEl.textContent = summary.Nutrition.sugar;
        budgetEl.textContent = summary.Budget.total.toFixed(2);
        householdListEl.innerHTML = summary.Household.checklist.map(i=>`<li>${i}</li>`).join("");
      } catch(err){
        console.error("Error updating summary:", err);
      }
    }
  </script>
</body>
</html>
