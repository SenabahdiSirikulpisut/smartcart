<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Cart WebApp</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
  .container { max-width: 500px; margin: auto; }
  button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
  .products { margin-top: 20px; }
  .product { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  .summary { background: #e0f7fa; padding: 10px; margin-top: 20px; border-radius: 6px; }
</style>
</head>
<body>
<div class="container">
  <h2>Welcome to Smart Cart</h2>
  <p>Select your segment:</p>
  <select id="segment">
    <option value="Nutrition">Nutrition / Goal Achiever</option>
    <option value="Budget">Budget Lover</option>
    <option value="Household">Household / Checklist</option>
  </select>
  <button onclick="startSession()">Start Session</button>
  
  <hr>
  <button onclick="scanQRCode()">Scan QR Code in Area</button>
  
  <div id="reader" style="width:100%; margin-top:20px;"></div>
  <div class="products" id="products"></div>
  <div class="summary" id="summary" style="display:none;"></div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
const BACKEND_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgrP8Gn-fIMq9q5ZDq9yFnspG7dmxtsAonApUt4_mNtU0QnIpOQPoKP7fieNQN49BS1lZfJiLYgBeYk1l3sXu8VO3VCBACD26JT8899Bh-zrujMxctGDWHODE06ctbT641rmFODnkwfCZNvV2_mg2z8r05Q4FfhYzNqq11q-vDsH_xsA2EbCGjy2Mbs0Ma-Aojw1EMW_-EUIFm3uCQFSGeZ8rIchxBlhOnaVswV8HUkwXln2dDDI2lD8-uagOrG6MRbykFWFypRlRngBJHwBiFWW2kKTquOkMP6p5qX&lib=M453lqMolX3z0uh-KbEC2B1RunvdIjpyt";
let customerId = null;
let segment = null;

// JSONP helper
function jsonp(url, params, callbackName) {
  const query = Object.keys(params).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`).join("&");
  const cb = callbackName || `cb_${Date.now()}`;
  return new Promise((resolve) => {
    window[cb] = function(data) {
      resolve(data);
      delete window[cb];
      script.remove();
    };
    const script = document.createElement("script");
    script.src = `${url}?${query}&callback=${cb}`;
    document.body.appendChild(script);
  });
}

// ---- Start session ----
async function startSession() {
  customerId = prompt("Enter your Customer ID");
  if(!customerId) return alert("Customer ID required!");
  segment = document.getElementById('segment').value;

  await jsonp(BACKEND_URL, { action: "startSession", customerId, segment });
  alert("Session started! Scan QR codes to get recommendations.");
}

// ---- QR Code scan ----
function scanQRCode() {
  const html5QrCode = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async qrCodeMessage => {
          await fetchProducts(qrCodeMessage);
          html5QrCode.stop();
        },
        errorMessage => {}
      );
    }
  }).catch(err => alert("Camera error: " + err));
}

// ---- Fetch products for QR zone ----
async function fetchProducts(zoneToken) {
  const data = await jsonp(BACKEND_URL, { action: "getProducts" });
  const container = document.getElementById('products');
  container.innerHTML = "";

  data.products.forEach(p => {
    const div = document.createElement('div');
    div.className = "product";
    div.innerHTML = `
      <b>${p.name}</b> (${p.category})<br>
      Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
      Price: ${p.price}<br>
      <button onclick="recordClick('${p.productId}')">View / Click</button>
    `;
    container.appendChild(div);
  });
}

// ---- Record click and fetch recommendations ----
async function recordClick(productId) {
  await jsonp(BACKEND_URL, { action: "recordClick", customerId, productId, segment, action:"click" });
  await fetchRecommendations(productId);
}

// ---- Fetch recommendations ----
async function fetchRecommendations(productId) {
  const data = await jsonp(BACKEND_URL, { action: "getRecommendations", productId });
  if (!data.recommendations || data.recommendations.length === 0) return;

  const container = document.getElementById('products');
  const recDiv = document.createElement('div');
  recDiv.innerHTML = `<h4>Recommended Products:</h4>`;

  data.recommendations.forEach(p => {
    const div = document.createElement('div');
    div.className = "product";
    div.innerHTML = `
      <b>${p.name}</b> (${p.category})<br>
      Calories: ${p.calories} | Protein: ${p.protein} | Sugar: ${p.sugar}<br>
      Price: ${p.price}<br>
      <button onclick="recordClick('${p.productId}')">View / Click</button>
    `;
    recDiv.appendChild(div);
  });
  container.appendChild(recDiv);
}

// ---- Fetch summary ----
async function fetchSummary() {
  const data = await jsonp(BACKEND_URL, { action: "getSummary", customerId });
  const sumDiv = document.getElementById('summary');
  sumDiv.style.display = "block";
  sumDiv.innerHTML = "<h4>Summary</h4>";

  if (segment === "Nutrition") {
    const n = data.summary.Nutrition;
    sumDiv.innerHTML += `Calories: ${n.calories}, Protein: ${n.protein}, Sugar: ${n.sugar}`;
  } else if (segment === "Budget") {
    sumDiv.innerHTML += `Total Spent: ${data.summary.Budget.total}`;
  } else if (segment === "Household") {
    sumDiv.innerHTML += "Checklist: " + data.summary.Household.checklist.join(", ");
  }
}
</script>
</body>
</html>
