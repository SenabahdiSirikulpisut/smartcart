<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartCart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { background-color: #f8f9fa; padding: 1rem; }
    #reader { width: 100%; max-width: 400px; margin: 0 auto; border-radius: 1rem; overflow: hidden; }
    .product-card { transition: transform 0.2s ease-in-out; margin-bottom: 1rem; }
    .product-card:hover { transform: scale(1.03); }
  </style>
</head>
<body class="container py-4">

  <h2 class="text-center mb-4">ðŸ›’ SmartCart</h2>

  <!-- Login Section -->
  <div id="loginSection" class="card p-3 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Customer ID</label>
      <input type="text" id="customerId" class="form-control" placeholder="Enter your ID" />
    </div>
    <div class="mb-3">
      <label class="form-label">Shopping Focus</label>
      <select id="focus" class="form-select">
        <option value="Nutrition">Nutrition</option>
        <option value="Budget">Budget</option>
        <option value="Household">Household</option>
      </select>
    </div>
    <button id="startSession" class="btn btn-primary w-100">Start Session</button>
  </div>

  <!-- Scanner Section -->
  <div id="scannerSection" class="text-center d-none mt-4">
    <button id="scanQRBtn" class="btn btn-success mb-3">Scan QR in Zones</button>
    <div id="reader" class="shadow d-none"></div>
  </div>

  <!-- Recommendations -->
  <div id="recommendationsSection" class="mt-4 d-none">
    <h5>Recommended for You</h5>
    <div id="recommendations" class="row g-3"></div>
  </div>

  <!-- Session Confirmation Modal -->
  <div class="modal fade" id="sessionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <h5>âœ… Session Started</h5>
          <p>Welcome! You can now scan QR codes to view product recommendations.</p>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Start Shopping</button>
        </div>
      </div>
    </div>
  </div>

  <script defer>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxfGHWQWxeMyQyi40iYq9vWRO1tSfl0ADSN-mOflDamZ5YrGR5HCGI6Dy0Ga45Nf-0Dsw/exec";
    let html5QrCode;
    let customerId = "";
    let focus = "";

    const loginSection = document.getElementById("loginSection");
    const scannerSection = document.getElementById("scannerSection");
    const recommendationsSection = document.getElementById("recommendationsSection");
    const recommendationsContainer = document.getElementById("recommendations");
    const scanQRBtn = document.getElementById("scanQRBtn");
    const readerDiv = document.getElementById("reader");

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startSession").addEventListener("click", async () => {
        customerId = document.getElementById("customerId").value.trim();
        focus = document.getElementById("focus").value;
        if (!customerId) return alert("Please enter Customer ID.");

        try {
          await jsonp(`${BACKEND_URL}?action=startSession&customerId=${customerId}&focus=${focus}`);
          loginSection.classList.add("d-none");
          scannerSection.classList.remove("d-none");
          const sessionModal = new bootstrap.Modal(document.getElementById("sessionModal"));
          sessionModal.show();
        } catch (err) {
          console.error(err);
          alert("Failed to start session. Please check your connection.");
        }
      });

      scanQRBtn.addEventListener("click", () => startScanner());
    });

    async function startScanner() {
      if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
      readerDiv.classList.remove("d-none");
      scanQRBtn.classList.add("d-none");

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          await html5QrCode.stop();
          html5QrCode.clear();
          readerDiv.classList.add("d-none");

          const recs = await fetchRecommendations(decodedText);
          displayProducts(recs);
          scanQRBtn.classList.remove("d-none");
        },
        (err) => {}
      );
    }

    async function fetchRecommendations(token) {
      return new Promise((resolve, reject) => {
        const callbackName = "cb_" + Date.now();
        window[callbackName] = (data) => {
          delete window[callbackName];
          resolve(data.recommendations || []);
        };
        const script = document.createElement("script");
        script.src = `${BACKEND_URL}?action=getRecommendations&productId=${encodeURIComponent(token)}&customerId=${customerId}&focus=${focus}&callback=${callbackName}`;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }

    async function recordClickAndFetchNext(productId) {
      return new Promise((resolve, reject) => {
        const callbackName = "cb_" + Date.now();
        window[callbackName] = (data) => {
          delete window[callbackName];
          resolve(data.recommendations || []);
        };
        const script = document.createElement("script");
        script.src = `${BACKEND_URL}?action=recordClick&customerId=${customerId}&productId=${productId}&callback=${callbackName}`;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }

    function displayProducts(products) {
      recommendationsSection.classList.remove("d-none");
      recommendationsContainer.innerHTML = "";
      if (!products.length) {
        recommendationsContainer.innerHTML = `<p class="text-muted">No recommendations found.</p>`;
        return;
      }

      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "col-md-4 product-card";
        card.innerHTML = `
          <div class="card h-100 shadow-sm text-center p-2">
            <h6>${p.name}</h6>
            <p class="small text-muted">${p.category}</p>
            <button class="btn btn-outline-primary btn-sm">View / Add</button>
          </div>
        `;
        card.querySelector("button").addEventListener("click", () => onProductClick(p.productId));
        recommendationsContainer.appendChild(card);
      });
    }

    async function onProductClick(productId) {
      const recs = await recordClickAndFetchNext(productId);
      displayProducts(recs);
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = "jsonp_callback_" + Math.round(100000 * Math.random());
        window[callbackName] = (data) => {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        const script = document.createElement("script");
        script.src = `${url}&callback=${callbackName}`;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
